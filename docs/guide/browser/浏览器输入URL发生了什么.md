# 浏览器输入 URL 发生了什么

## 前言

前端工程师几乎每天都要和浏览器打交道，所以，了解浏览器是如何工作的，能够使我们快速定位问题和提升用户体验。

## 用户输入

地址栏会判断是搜索内容还是请求 URL。
- 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
- 如果判断输入内容符合 URL 规则，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL。

## URL 请求过程

1. 查找本地缓存是否有资源，如果有就直接获取，没有的话就进入下一步。
2. 进行 DNS 解析，以获取请求的 IP 地址。如果协议是 https 还需要进行 TLS 连接。
3. IP 地址和服务器的 TCP 连接。
4. 建立连接后，发送请求头等信息给服务器。
5. 服务器接收到请求信息，将响应头等数据返回给客户端。
    - 重定向：网络进程解析响应头，如果状态码 301 或者 302，那么说明重定向到其他 URL，而这个 URL 是 Location 字段值。
    - 响应数据类型处理：Content-Type 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型，然后浏览器会根据 Content-Type 的值来决定如何显示响应体的内容。

## 准备渲染进程

### 什么是同一站点

- 根域名：极客时间（geekbang.org）。
- 协议：http:// 或 https://。
- 根域名下的所有子域名和不同的端口。

### 打开一个新页面的渲染进程策略

- 通常情况下，打开新的页面都会使用单独的渲染进程。
- 如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点的话，那么 B 页面复用 A 页面的渲染进程；如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

## 提交文档

1. 网络进程告知浏览器进程，可以让渲染进程过来取资源了。
2. 浏览器进程通知渲染进程，渲染进程打开与网络进程之间的传输通道，等所有资源都传输完后，渲染进程通知浏览器进程。
3. 浏览器进程收到渲染进程的提交完成信息后，就开始更新安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

## 渲染阶段

### 构建 DOM 树

这是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构——DOM 树。

### 样式计算

1. 把 CSS 转换为浏览器能够理解的结构——styleSheets。
2. 转换样式表中的属性值，使其标准化。即浏览器需要将 css 的所有属性值转换为渲染引擎容易理解的、标准化的计算值。
3. 计算出 DOM 树中每个节点的具体样式，运用继承规则和层叠规则。

总之，样式计算阶段的目的是为了计算出 DOM 节点中每个元素的具体样式，在计算过程中需要遵守 CSS 的继承和层叠两个规则。这个阶段最终输出的内容是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。

### 布局阶段

## 总结

- 服务器可以根据响应头来控制浏览器的行为，如跳转、网络数据类型判断。
- Chrome 默认采用每个标签对应一个渲染进程，但是如果两个页面属于同一站点，那这两个标签会使用同一个渲染进程。
- 浏览器的导航过程涵盖了从用户发起请求到提交文档给渲染进程的中间所有阶段。

导航流程很重要，它是网络加载流程和渲染流程之间的一座桥梁，如果你理解了导航流程，那么你就能完整串起来整个页面显示流程，这对于你理解浏览器的工作原理起到了点睛的作用。

这是学习《极客时间——浏览器工作原理与实践》李兵老师课程的笔记。